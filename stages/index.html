
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Pure python extensions of the C++ micro-manager core">
      
      
      
        <link rel="canonical" href="https://tlambert03.github.io/microsim/stages/">
      
      
        <link rel="prev" href="../ex_em_methodology/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Simulation Stages - microsim</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bcfcd587.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#simulation-stages" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="microsim" class="md-header__button md-logo" aria-label="microsim" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M160 32c0-17.7 14.3-32 32-32h32c17.7 0 32 14.3 32 32 17.7 0 32 14.3 32 32v224c0 17.7-14.3 32-32 32 0 17.7-14.3 32-32 32h-32c-17.7 0-32-14.3-32-32-17.7 0-32-14.3-32-32V64c0-17.7 14.3-32 32-32zM32 448h288c70.7 0 128-57.3 128-128s-57.3-128-128-128v-64c106 0 192 86 192 192 0 49.2-18.5 94-48.9 128H480c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32zm80-64h192c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            microsim
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Simulation Stages
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/tlambert03/microsim" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    tlambert03/microsim
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="microsim" class="md-nav__button md-logo" aria-label="microsim" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M160 32c0-17.7 14.3-32 32-32h32c17.7 0 32 14.3 32 32 17.7 0 32 14.3 32 32v224c0 17.7-14.3 32-32 32 0 17.7-14.3 32-32 32h-32c-17.7 0-32-14.3-32-32-17.7 0-32-14.3-32-32V64c0-17.7 14.3-32 32-32zM32 448h288c70.7 0 128-57.3 128-128s-57.3-128-128-128v-64c106 0 192 86 192 192 0 49.2-18.5 94-48.9 128H480c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32zm80-64h192c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16z"/></svg>

    </a>
    microsim
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tlambert03/microsim" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    tlambert03/microsim
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    microsim
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../concept/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Conceptual Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ex_em_methodology/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Excitation and Emission Methodology
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Simulation Stages
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Simulation Stages
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#space-creation" class="md-nav__link">
    <span class="md-ellipsis">
      Space creation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ground-truth" class="md-nav__link">
    <span class="md-ellipsis">
      Ground Truth
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#emission-flux" class="md-nav__link">
    <span class="md-ellipsis">
      Emission Flux
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Emission Flux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#builtin-library-of-common-filter-sets" class="md-nav__link">
    <span class="md-ellipsis">
      Builtin library of common filter sets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optical-configurations-from-fpbase" class="md-nav__link">
    <span class="md-ellipsis">
      Optical Configurations from FPbase
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optical-image" class="md-nav__link">
    <span class="md-ellipsis">
      Optical Image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#digital-image" class="md-nav__link">
    <span class="md-ellipsis">
      Digital Image
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#space-creation" class="md-nav__link">
    <span class="md-ellipsis">
      Space creation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ground-truth" class="md-nav__link">
    <span class="md-ellipsis">
      Ground Truth
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#emission-flux" class="md-nav__link">
    <span class="md-ellipsis">
      Emission Flux
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Emission Flux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#builtin-library-of-common-filter-sets" class="md-nav__link">
    <span class="md-ellipsis">
      Builtin library of common filter sets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optical-configurations-from-fpbase" class="md-nav__link">
    <span class="md-ellipsis">
      Optical Configurations from FPbase
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optical-image" class="md-nav__link">
    <span class="md-ellipsis">
      Optical Image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#digital-image" class="md-nav__link">
    <span class="md-ellipsis">
      Digital Image
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="simulation-stages">Simulation Stages<a class="headerlink" href="#simulation-stages" title="Permanent link">#</a></h1>
<p>The simulation is divided into several stages, each of which is responsible for a specific part of the simulation process. The stages are executed in the following order:</p>
<ol>
<li><a href="#space-creation">Establishing the 3D space in which the simulation is performed</a></li>
<li><a href="#ground-truth">Generation of the ground truth target/fluorophore positions</a></li>
<li><a href="#emission-flux">Generation of emission photon fluxes</a></li>
<li><a href="#optical-image">Forming the optical image</a></li>
<li><a href="#digital-image">Noise and downsampling in the digital image</a></li>
</ol>
<h2 id="space-creation">Space creation<a class="headerlink" href="#space-creation" title="Permanent link">#</a></h2>
<ul>
<li><strong>value units</strong>: N/A</li>
<li><strong>dimensions introduced</strong>:<ul>
<li><strong><code>Z</code></strong>: planes along the optical axis (units length).</li>
<li><strong><code>Y</code></strong>: rows (units length).</li>
<li><strong><code>X</code></strong>: columns (units length).</li>
</ul>
</li>
</ul>
<p>The simulation starts with the declaration of a discrete 3D volume in which the
simulation will take place. The volume is defined by its shape and scale (voxel
size in physical units).  Typically, this volume will be many times larger than
the final image size (in terms of shape) so as to be able to represent very fine
ground truth structures that will be blurred by the imaging system. At a later
stage, this volume will be downsampled to the final image shape and scale
(representing the detector pixel sizes).</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>The following example creates a 3D volume of shape (512, 1024, 1024) with voxel
sizes of (0.04, 0.02, 0.02) microns (i.e. a volume of 20.48 x 20.48 x 20.48 µm).
The <code>output_space</code> parameter specifies that the final image will be downsampled
by a factor of 4, into a volume of shape (128, 256, 256) with voxel sizes of
(0.16, 0.08, 0.08) microns.  Note that the <em>extents</em> of the ground truth and
output volumes are the same.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">microsim</span> <span class="kn">import</span> <span class="n">Simulation</span>

<span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span>
    <span class="n">truth_space</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)},</span>
    <span class="n">output_space</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;downscale&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
<span class="p">)</span>
</code></pre></div>
</div>
<h2 id="ground-truth">Ground Truth<a class="headerlink" href="#ground-truth" title="Permanent link">#</a></h2>
<ul>
<li><strong>value units</strong>: fluorophore counts</li>
<li><strong>dimensions introduced</strong>:<ul>
<li><strong><code>F</code></strong>: Fluorophore (categorical unit [<code>FluorophoreDistribution</code>][microsim.schema.FluorophoreDistribution])</li>
</ul>
</li>
</ul>
<p>The ground truth stage is responsible for generating the positions of the
fluorophores in the 3D space. Each
[<code>FluorophoreDistribution</code>][microsim.schema.FluorophoreDistribution] object in
the simulation specifies the position, number, species (e.g. mEGFP) of
fluorophores in the volume. The ground truth will have dimensions <code>(F, Z, Y, X)</code>
where <code>len(F)</code> is determined by the number of <code>labels</code> in the <code>sample</code> field of
the <code>Simulation</code>; the values in the ground truth array represent the number of
fluorophores present at each voxel in the volume.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Here is an example using a ground-truth generator
<a class="autorefs autorefs-internal" href="../api/#microsim.schema.sample.MatsLines"><code>MatsLines</code></a> that draws random lines in the
volume.  The fluorophore is specified to be <code>EGFP</code>.</p>
<p><em>When specifying the fluorophore as a string, microsim will load properties from
<a href="https://www.fpbase.org/">FPbase</a>. Otherwise, you may directly create a
[<code>Fluorophore</code>][microsim.schema.Fluorophore] object.</em></p>
<div class="highlight"><pre><span></span><code><span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span>
    <span class="c1"># ...,</span>
    <span class="n">sample</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;distribution&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;matslines&#39;</span><span class="p">,</span> <span class="s1">&#39;density&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;azimuth&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                <span class="s1">&#39;fluorophore&#39;</span><span class="p">:</span> <span class="s1">&#39;EGFP&#39;</span>
            <span class="p">}</span>
        <span class="p">],</span>
    <span class="p">},</span>
<span class="p">)</span>
</code></pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Have a cool ground truth generator?</p>
<p>This is obviously a very important stage, as the quality of the ground truth
will directly affect the realism of the simulation. We provide several built-in
ground truth generators, but <em>we would love to expand this with additional
user-contributed methods</em>. Please <a href="https://github.com/tlambert03/microsim/pulls">open a
PR</a>!
We will help <img alt="🙂" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f642.svg" title=":slightly_smiling_face:" /></p>
</div>
<h2 id="emission-flux">Emission Flux<a class="headerlink" href="#emission-flux" title="Permanent link">#</a></h2>
<ul>
<li><strong>value units</strong>: photons / second</li>
<li><strong>dimensions introduced</strong>:<ul>
<li><strong><code>W</code></strong>: wavelength (units length)</li>
<li><strong><code>C</code></strong>: Channel (categorical unit <a class="autorefs autorefs-internal" href="../api/#microsim.schema.optical_config.OpticalConfig"><code>OpticalConfig</code></a>)</li>
</ul>
</li>
</ul>
<p>In this stage, fluorophore counts are converted into emission photon fluxes in
units of photons per second (per voxel). This is still considered to be in the
pre-optical domain, before the effects of the detection optics are applied
(but <em>after</em> any effects of the excitation optics are applied).</p>
<p>This conversion will depend on:</p>
<ul>
<li>the excitation spectrum of the fluorophore</li>
<li>the spectrum and irradiance (W/cm^2) of the excitation light source and filters</li>
<li>the pattern of illumination (particularly relevant for structured illumination)</li>
<li>the molecular brightness of the fluorophore (extinction coefficient and quantum yield).</li>
</ul>
<p>The output of this stage is a 6D array with dimensions <code>(W, C, F, Z, Y, X)</code>
with two new dimensions:</p>
<ul>
<li>The wavelength (<code>W</code>) dimension has coordinates representing the wavelength of
  the emitted photons, and <code>len(W)</code> is determined by the number of wavelength bins
  in the simulation.</li>
<li>The channel (<code>C</code>) dimension has coordinates representing the different optical
  configurations (e.g. filter sets) in the simulation, and <code>len(C)</code> is determined
  by the number of <code>channels</code> in the simulation.</li>
</ul>
<p>It's worth pointing out that we need to calculate the emission spectral flux for
<em>every</em> combination of fluorophore and channel in order to be able to include
bleedthrough and crosstalk effects in the simulation. For example <code>data[{'F': 0,
'C': 1}]</code> would represent the emission flux of fluorophore 0 when excited by
channel 1. This is why both F and C remain at this stage.  </p>
<div class="admonition examples">
<p class="admonition-title">Examples</p>
<p>Each channel in the simulation is an arrangement of optical filters
and light sources.  (If the light source is omitted, it is assumed to be
a flat white light source, and the excitation filter spectra are used directly).</p>
<div class="highlight"><pre><span></span><code><span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span>
    <span class="c1"># ...,</span>
    <span class="n">channels</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Green&quot;</span><span class="p">,</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bandpass&quot;</span><span class="p">,</span> <span class="s2">&quot;bandcenter&quot;</span><span class="p">:</span> <span class="mi">470</span><span class="p">,</span> <span class="s2">&quot;bandwidth&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">&quot;placement&quot;</span><span class="p">:</span> <span class="s2">&quot;EX&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;longpass&quot;</span><span class="p">,</span> <span class="s2">&quot;cuton&quot;</span><span class="p">:</span> <span class="mi">495</span><span class="p">,</span> <span class="s2">&quot;placement&quot;</span><span class="p">:</span> <span class="s2">&quot;BS&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bandpass&quot;</span><span class="p">,</span> <span class="s2">&quot;bandcenter&quot;</span><span class="p">:</span> <span class="mi">525</span><span class="p">,</span> <span class="s2">&quot;bandwidth&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;placement&quot;</span><span class="p">:</span> <span class="s2">&quot;EM&quot;</span><span class="p">}</span>
            <span class="p">],</span>
        <span class="p">}</span>
    <span class="p">],</span>
<span class="p">)</span>
</code></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">TODO</p>
<p>Things like fluorophore lifetime, ground state depletion, and photobleaching
rate also need to be considered in this stage, but are not yet implemented. In
order to properly simulate these effects, the simulation will need to also take
into account the temporal aspects of the illumination pattern even <em>within</em> a
single image.  That's a lot of complexity.  So for now, everything will be
simulated as a steady-state emission flux.</p>
</div>
<h3 id="builtin-library-of-common-filter-sets">Builtin library of common filter sets<a class="headerlink" href="#builtin-library-of-common-filter-sets" title="Permanent link">#</a></h3>
<p><code>microsim</code> provides a library of common optical configs.  For example,
the above filter set arrangement shown above is a very common FITC filter set,
which can be loaded from the library as follows:</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">microsim.schema.optical_config</span> <span class="kn">import</span> <span class="n">lib</span>

<span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span>
    <span class="c1"># ...,</span>
    <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="n">lib</span><span class="o">.</span><span class="n">FITC</span><span class="p">],</span>
<span class="p">)</span>
</code></pre></div>
</div>
<h3 id="optical-configurations-from-fpbase">Optical Configurations from FPbase<a class="headerlink" href="#optical-configurations-from-fpbase" title="Permanent link">#</a></h3>
<p>You can also load optical configurations from <a href="https://www.fpbase.org/microscopes">FPbase
microscope</a> using the syntax
<code>microscope_id::config_name</code>. For example, to load the "Widefield Green" config
from the <a href="https://www.fpbase.org/microscope/wKqWbgApvguSNDSRZNSfpN/?c=Widefield%20Green">Example Simple Widefield microscope on
FPbase</a>,
you would grab the microscope id from the URL (in this case <code>wKqWbgAp</code>) and add
the config name (<code>Widefield Green</code>), separated by two colons (<code>::</code>):</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="highlight"><pre><span></span><code><span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span>
    <span class="c1"># ...,</span>
    <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;wKqWbgAp::Widefield Green&quot;</span><span class="p">],</span>
<span class="p">)</span>
</code></pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Here are some useful FPbase microscopes with brand-specific filter set catalogs:</p>
<ul>
<li><a href="https://www.fpbase.org/microscope/PMtA2nB6Ld2Y2XvrF5zUuP/">Chroma Filter Sets</a></li>
<li><a href="https://www.fpbase.org/microscope/HGtCWRnyn8joPY5WF2t3zW/">Semrock Filter Sets</a></li>
<li><a href="https://www.fpbase.org/microscope/up3K5Tp3jwLWXtoTt8T9vB/">Nikon Filter Sets</a></li>
<li><a href="https://www.fpbase.org/microscope/VgeWjEPrGiSL6saRi9myA8/">Zeiss Filter Sets</a></li>
</ul>
</div>
<h2 id="optical-image">Optical Image<a class="headerlink" href="#optical-image" title="Permanent link">#</a></h2>
<p><em>i.e. the "filtered" Emission Flux</em></p>
<ul>
<li><strong>value units</strong>: photons / second</li>
<li><strong>dimensions lost</strong>:<ul>
<li><strong><code>W</code></strong>: wavelength</li>
<li><strong><code>F</code></strong>: Fluorophore</li>
</ul>
</li>
</ul>
<p>In this stage, emission photon fluxes are convolved with the optical point
spread function (PSF) of the microscope and wavelengths are filtered based on
the emission path configuration to form the (noise free) optical image.</p>
<div class="admonition info">
<p class="admonition-title">PSF</p>
<p>The <a href="https://en.wikipedia.org/wiki/Point_spread_function">point spread function</a>
describes the response of the imaging system to a point source. In the context of
fluorescence microscopy, the PSF describes how light emitted from a point
emitter (i.e. a single fluorophore) is "spread out" or blurred in the image due
to diffraction.</p>
<p>In microsim, the PSF largely be determined by the <a class="autorefs autorefs-internal" href="../api/#microsim.schema.lens.ObjectiveLens"><code>ObjectiveLens</code></a> and the
<a href="../api/#modality"><code>Modality</code></a> of the simulation</p>
</div>
<p>The output of this stage is a 4D array with dimensions <code>(C, Z, Y, X)</code> where the
wavelength and fluorophore dimensions have been collapsed into the channel. Note
that each channel dimension will contain the emission of <em>all</em> fluorophores that
emit in the wavelength range of that channel. This is important for simulating
"crosstalk" or "bleedthrough".  Even for the case of a spectral detection system,
the <code>W</code> dimension will be removed, but there would be a channel for each wavelength
bin in the detector.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>This example sets up a simulation with a confocal microscope with a 1.4 NA
objective lens and a 1.2 AU pinhole. The simulation is set up to use the "491"
optical configuration from the <a href="https://www.fpbase.org/microscope/4yL4ggAo/?c=491">Example Yokogawa
Setup</a> (spinning disc confocal)
microscope on FPbase.</p>
<div class="highlight"><pre><span></span><code><span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span>
    <span class="c1"># ...,</span>
    <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;4yL4ggAo::491&quot;</span><span class="p">],</span>
    <span class="n">objective_lens</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;numerical_aperture&quot;</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span> <span class="s2">&quot;immersion_medium_ri&quot;</span><span class="p">:</span> <span class="mf">1.515</span><span class="p">,</span> <span class="s1">&#39;specimen_ri&#39;</span><span class="p">:</span> <span class="mf">1.33</span><span class="p">},</span>
    <span class="n">modality</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;confocal&quot;</span><span class="p">,</span> <span class="s1">&#39;pinhole_au&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">},</span>
<span class="p">)</span>
</code></pre></div>
</div>
<h2 id="digital-image">Digital Image<a class="headerlink" href="#digital-image" title="Permanent link">#</a></h2>
<ul>
<li><strong>value units</strong>: gray levels</li>
</ul>
<p>The final stage of the simulation is the conversion of the filtered optical
image into a digital image. This stage includes the addition of noise
(<a href="https://en.wikipedia.org/wiki/Shot_noise">photon or shot noise</a> due to the
discrete nature of photons, <a href="https://hamamatsu.magnet.fsu.edu/articles/ccdsnr.html">read
noise</a> due to imprecision
in the detector, and other sources) as well as downsampling to the final image
resolution.</p>
<p>The output of this stage is a 4D array with dimensions <code>(C, Z, Y, X)</code> where the
values are in units of gray levels (integers).  The values in the digital image
will depend on the settings of the <code>detector</code> and the <code>output_space</code>.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>This example sets up a simulation with a 16-bit detector with a read noise of
2 electrons rms, and a quantum efficiency of 0.82.  Note that, for now,
the "pixel size" is implicitly determined by the <code>output_space</code> parameter.
But that will change in the future.</p>
<div class="highlight"><pre><span></span><code><span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span>
    <span class="c1"># ...,</span>
    <span class="n">output_space</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;downscale&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
    <span class="n">detector</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;bit_depth&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;read_noise&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;qe&quot;</span><span class="p">:</span> <span class="mf">0.82</span><span class="p">},</span>
<span class="p">)</span>
</code></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">TODO</p>
<p>We don't yet model pixel-specific characterists of sCMOS cameras.  Ideally,
we will generate a random "instance" of an sCMOS camera with noise, gain,
and offset distribution pulled from a typical CMOS.</p>
</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../ex_em_methodology/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Excitation and Emission Methodology">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Excitation and Emission Methodology
              </div>
            </div>
          </a>
        
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.tabs.link", "content.code.annotate", "content.code.copy", "navigation.footer"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  </body>
</html>